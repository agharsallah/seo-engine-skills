---
title: Detect presence of known malware signatures using ClamAV in downloadable files or local files
impact: CRITICAL
impactDescription: Hosting malware harms users and violates Google policies.
tags: security
inputFields:
  - name: url
    required: false
    description: URL of the resource to check (mutually exclusive with html-file).
  - name: html-file
    required: false
    description: Path to a local HTML (or any) file to check (mutually exclusive with url).
  - name: header
    required: false
    description: Optional request headers in 'Key: Value' format (repeatable).
  - name: timeout
    required: false
    description: HTTP timeout in seconds (default: 20).
  - name: max-bytes
    required: false
    description: Maximum download size cap in bytes (default: 64 MiB).
  - name: clamd-unix-socket
    required: false
    description: Path to clamd unix socket (default: autodetect common paths).
  - name: clamd-host
    required: false
    description: clamd TCP host (if not using unix socket).
  - name: clamd-port
    required: false
    description: clamd TCP port (default: 3310).
---

## MALWARE_HOSTING_DETECTION
Detects presence of known malware signatures using ClamAV in downloadable files or local files.

## Evidence to collect
- SHA256 hash of the content
- Content length in bytes
- ClamAV endpoint used for scanning
- ClamAV version information
- ClamAV signature name (if malware detected)

## Logic (pseudocode)
Inputs: url OR html-file, optional headers and ClamAV configuration
1. If URL provided:
   - Perform a GET request with optional headers and timeout
   - If response status != 200, skip (not applicable)
   - Download content to temporary file (respecting max-bytes limit)
2. If local file provided:
   - Verify file exists
3. Compute SHA256 hash of the content
4. Connect to ClamAV daemon (unix socket or TCP, with autodetection fallback)
5. Scan content using ClamAV
6. If ClamAV detects malware signature, flag as malware hosting
7. Clean up temporary files

## Pass condition
ClamAV does not detect any malware signatures in the resource content.

## Failure messages
Malware detected: resource at '${source}' flagged by ClamAV signature '${signature}'.

## Examples
### Passing
```json
{
  "check": "MALWARE_HOSTING_DETECTION",
  "pass": true,
  "message": "Resource clean: no ClamAV malware signature matched.",
  "evidence": {
    "sha256": "abc123...",
    "content_length": 1024,
    "clamav_endpoint": "unix:/var/run/clamav/clamd.ctl",
    "clamav_version": "ClamAV 0.103.8/..."
  }
}
```

### Failing
```json
{
  "check": "MALWARE_HOSTING_DETECTION",
  "pass": false,
  "message": "Malware detected: resource at 'https://example.com/file.exe' flagged by ClamAV signature 'Eicar-Test-Signature'.",
  "evidence": {
    "sha256": "def456...",
    "content_length": 68,
    "clamav_endpoint": "tcp:127.0.0.1:3310",
    "clamav_version": "ClamAV 0.103.8/...",
    "clamav_signature": "Eicar-Test-Signature"
  }
}
```

## Script Location
Implementation: [malware_hosting_detection.py](../scripts/malware_hosting_detection/malware_hosting_detection.py)

## Dependencies
- ClamAV daemon (clamd) running and accessible
- Python packages: `clamd`, `requests`

## Usage Examples
```bash
# Scan a URL
python malware_hosting_detection.py --url https://example.com/file.exe

# Scan a local file
python malware_hosting_detection.py --html-file ./suspicious.html

# Scan with custom headers and timeout
python malware_hosting_detection.py --url https://example.com/file.exe --header "Authorization: Bearer token" --timeout 30

# Use specific ClamAV TCP connection
python malware_hosting_detection.py --url https://example.com/file.exe --clamd-host localhost --clamd-port 3310
```

### References
Google Search documentation — https://developers.google.com/search/docs/appearance/security
ClamAV documentation — https://docs.clamav.net/